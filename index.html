<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal de Usuario</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins :wght@400;600&display=swap" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #e0e0e0;
      overflow: hidden;
      position: relative;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .cloud-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 200%;
      height: 100%;
      background: linear-gradient(to bottom, #a0c0e0, #c0d0e0);
      animation: moveClouds 60s linear infinite;
      z-index: -2;
    }

    @keyframes moveClouds {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .page-container {
      max-width: 600px;
      width: 90%;
      margin: 50px auto;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      z-index: 1;
      position: relative;
      transition: transform 0.3s ease-in-out;
      display: none;
      box-sizing: border-box;
    }

    .page-container:hover {
      transform: translateY(-5px);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.4);
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      color: #333;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .form-group input::placeholder {
      color: rgba(51, 51, 51, 0.7);
    }

    button {
      background-color: rgba(100, 149, 237, 0.7);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: block;
      width: 100%;
      margin-top: 20px;
    }

    button:hover {
      background-color: rgba(70, 130, 180, 0.8);
      transform: scale(1.02) translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #profile-page h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .profile-info p {
      margin-bottom: 10px;
      color: #555;
      padding: 8px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
    }

    .profile-info strong {
      color: #333;
    }

    .profile-photo {
      text-align: center;
      margin-bottom: 20px;
    }

    .profile-photo img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .edit-profile-form {
      display: none;
      margin-top: 20px;
    }

    .edit-profile-form input[type="text"],
    .edit-profile-form input[type="email"] {
      width: 100%;
      margin-bottom: 10px;
    }

    .edit-profile-form label {
      display: block;
      margin-bottom: 5px;
      color: #333;
    }

    .edit-profile-form input[type="file"] {
      margin-top: 10px;
    }

    #calendar-page .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 10px;
    }

    #calendar-page .calendar-header h2 {
      margin: 0;
      font-size: 1.5em;
      color: #333;
    }

    #calendar-page .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
    }

    #calendar-page .day-name {
      font-weight: bold;
      color: #555;
      padding: 10px 0;
    }

    #calendar-page .day {
      padding: 10px 5px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      position: relative;
      overflow: hidden;
      color: #333;
    }

    #calendar-page .day:hover {
      background-color: rgba(255, 255, 255, 0.6);
      transform: scale(1.05);
    }

    #calendar-page .back-button {
      background-color: rgba(150, 150, 150, 0.7);
      margin-top: 20px;
      width: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #calendar-page .back-button:hover {
      background-color: rgba(120, 120, 120, 0.8);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-content h3 {
      margin-bottom: 10px;
    }

    .modal-content select,
    .modal-content button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <!-- Fondo animado -->
  <div class="cloud-background"></div>

  <!-- Contenedores -->
  <div id="login-page" class="page-container">
    <h2>Iniciar Sesión</h2>
    <div class="form-group">
      <label for="email">Correo Electrónico:</label>
      <input type="email" id="email" placeholder="Ingresa tu correo">
    </div>
    <div class="form-group">
      <label for="password">Contraseña:</label>
      <input type="password" id="password" placeholder="Ingresa tu contraseña">
    </div>
    <button id="login-button">Entrar</button>
  </div>

  <div id="profile-page" class="page-container">
    <div class="profile-photo">
      <img id="profile-pic" src="https://placehold.co/100x100/cccccc/999999?text=Foto+Perfil " alt="Foto de perfil">
    </div>
    <h2>Mi Perfil</h2>
    <div class="profile-info">
      <p><strong>Nombre Completo:</strong> <span id="nombre-display">Ruth Pérez</span></p>
      <p><strong>RUT:</strong> <span id="rut-display">12.345.678-9</span></p>
      <p><strong>Dirección:</strong> <span id="direccion-display">Calle Falsa 123, Santiago</span></p>
      <p><strong>Teléfono:</strong> <span id="telefono-display">+56 9 1234 5678</span></p>
      <p><strong>Correo:</strong> <span id="correo-display">ruth.perez@example.com</span></p>
    </div>
    <button id="edit-profile-button">Editar Perfil</button>
    <button id="manage-permissions-button">Gestionar Permisos y Feriados</button>
    <button onclick="showPage(loginPage)" style="margin-top: 10px;">⬅️ Atrás</button>

    <!-- Formulario de edición de perfil -->
    <div id="edit-profile-form" class="edit-profile-form">
      <h3>Editar Datos</h3>
      <div class="form-group">
        <label for="nombre-input">Nombre:</label>
        <input type="text" id="nombre-input" placeholder="Tu nombre completo">
      </div>
      <div class="form-group">
        <label for="rut-input">RUT:</label>
        <input type="text" id="rut-input" placeholder="Ej: 12.345.678-9">
      </div>
      <div class="form-group">
        <label for="direccion-input">Dirección:</label>
        <input type="text" id="direccion-input" placeholder="Tu dirección">
      </div>
      <div class="form-group">
        <label for="telefono-input">Teléfono:</label>
        <input type="text" id="telefono-input" placeholder="+56 9 1234 5678">
      </div>
      <div class="form-group">
        <label for="correo-input">Correo:</label>
        <input type="email" id="correo-input" placeholder="tu@email.com">
      </div>
      <div class="form-group">
        <label for="foto-input">Subir Foto:</label>
        <input type="file" id="foto-input" accept="image/*">
      </div>
      <button onclick="saveProfile()">Guardar Cambios</button>
      <button onclick="hideEditForm()">Cancelar</button>
    </div>
  </div>

  <div id="calendar-page" class="page-container">
    <div class="calendar-header">
      <div class="nav-buttons">
        <button id="prevMonth">Anterior</button>
        <button id="nextMonth">Siguiente</button>
      </div>
      <h2 id="currentMonthYear"></h2>
    </div>
    <div class="calendar-grid"></div>
    <button id="back-to-profile-button" class="back-button">Volver al Perfil</button>
  </div>

  <!-- Modal para solicitar permiso -->
  <div class="modal" id="request-modal">
    <div class="modal-content">
      <h3>Seleccionaste <span id="selected-days-count">0</span> día(s)</h3>
      <select id="leave-type">
        <option value="admin">Permiso Administrativo</option>
        <option value="sick">Licencia Médica</option>
        <option value="marriage">Permiso por Matrimonio</option>
        <option value="holiday">Feriado</option>
      </select>
      <button onclick="generatePDF()">Descargar PDF</button>
      <button onclick="closeModal()">Cerrar</button>
    </div>
  </div>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>

  <script>
    const loginPage = document.getElementById('login-page');
    const profilePage = document.getElementById('profile-page');
    const calendarPage = document.getElementById('calendar-page');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const managePermissionsButton = document.getElementById('manage-permissions-button');
    const backToProfileButton = document.getElementById('back-to-profile-button');

    const calendarGrid = document.querySelector('#calendar-page .calendar-grid');
    const currentMonthYear = document.getElementById('currentMonthYear');
    const prevMonthButton = document.getElementById('prevMonth');
    const nextMonthButton = document.getElementById('nextMonth');
    const modal = document.getElementById('request-modal');
    const selectedDaysCount = document.getElementById('selected-days-count');
    const leaveTypeSelect = document.getElementById('leave-type');

    let currentDate = new Date();
    let selectedDays = [];

    const chileanHolidays = [
      { month: 0, day: 1, name: "Año Nuevo" },
      { month: 3, day: 18, name: "Viernes Santo" },
      { month: 3, day: 19, name: "Sábado Santo" },
      { month: 4, day: 1, name: "Día del Trabajador" },
      { month: 4, day: 21, name: "Día de las Glorias Navales" },
      { month: 5, day: 26, name: "San Pedro y San Pablo" },
      { month: 6, day: 16, name: "Virgen del Carmen" },
      { month: 7, day: 15, name: "Asunción de la Virgen" },
      { month: 8, day: 18, name: "Independencia Nacional" },
      { month: 8, day: 19, name: "Día de las Glorias del Ejército" },
      { month: 9, day: 31, name: "Día Nacional de las Iglesias Evangélicas y Protestantes" },
      { month: 10, day: 1, name: "Día de Todos los Santos" },
      { month: 11, day: 8, name: "Inmaculada Concepción" },
      { month: 11, day: 25, name: "Navidad" }
    ];

    function showPage(pageElement) {
      [loginPage, profilePage, calendarPage].forEach(p => p.style.display = 'none');
      pageElement.style.display = 'block';
      if (pageElement === calendarPage) renderCalendar(currentDate);
    }

    loginButton.addEventListener('click', () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      if (email && password) showPage(profilePage);
      else alert('Por favor, ingresa tu correo y contraseña.');
    });

    managePermissionsButton.addEventListener('click', () => showPage(calendarPage));
    backToProfileButton.addEventListener('click', () => showPage(profilePage));

    prevMonthButton.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    });

    nextMonthButton.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    });

    function renderCalendar(date) {
      calendarGrid.innerHTML = '';
      const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
      dayNames.forEach(name => {
        const div = document.createElement('div');
        div.classList.add('day-name');
        div.textContent = name;
        calendarGrid.appendChild(div);
      });

      const year = date.getFullYear();
      const month = date.getMonth();
      currentMonthYear.textContent = new Intl.DateTimeFormat('es-CL', { month: 'long', year: 'numeric' }).format(date);

      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const numDaysInMonth = lastDayOfMonth.getDate();

      let firstDayOfWeek = firstDayOfMonth.getDay();
      firstDayOfWeek = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1;

      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = firstDayOfWeek; i > 0; i--) {
        const div = document.createElement('div');
        div.classList.add('day', 'other-month');
        div.textContent = prevMonthLastDay - i + 1;
        calendarGrid.appendChild(div);
      }

      for (let i = 1; i <= numDaysInMonth; i++) {
        const div = document.createElement('div');
        div.classList.add('day');
        div.textContent = i;
        const currentDay = new Date(year, month, i);
        if (currentDay.toDateString() === new Date().toDateString()) div.classList.add('today');

        const isHoliday = chileanHolidays.some(holiday =>
          holiday.month === month && holiday.day === i
        );
        if (isHoliday) {
          div.classList.add('holiday');
          const indicator = document.createElement('span');
          indicator.classList.add('event-indicator');
          indicator.textContent = 'Feriado';
          div.appendChild(indicator);
        }

        div.addEventListener('click', () => {
          div.classList.toggle('selected');
          updateSelectedDays();
        });

        calendarGrid.appendChild(div);
      }

      const totalDaysDisplayed = firstDayOfWeek + numDaysInMonth;
      const remainingDays = 42 - totalDaysDisplayed;
      for (let i = 1; i <= remainingDays; i++) {
        if (totalDaysDisplayed + i > 35 && totalDaysDisplayed + i <= 42) {
          const div = document.createElement('div');
          div.classList.add('day', 'other-month');
          div.textContent = i;
          calendarGrid.appendChild(div);
        }
      }
    }

    function updateSelectedDays() {
      selectedDays = Array.from(document.querySelectorAll('.day.selected')).map(d => parseInt(d.textContent));
      if (selectedDays.length > 0) openModal();
    }

    function openModal() {
      selectedDaysCount.textContent = selectedDays.length;
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const nombre = document.getElementById('nombre-display').textContent;
      const rut = document.getElementById('rut-display').textContent;
      const tipoPermiso = leaveTypeSelect.options[leaveTypeSelect.selectedIndex].text;

      const diasOrdenados = [...selectedDays].sort((a, b) => a - b);
      const mesActual = new Date(currentDate).toLocaleString("es-ES", { month: "long" });
      const añoActual = currentDate.getFullYear();

      const fechaInicio = `${diasOrdenados[0]} de ${mesActual} de ${añoActual}`;
      const fechaFin = `${diasOrdenados[diasOrdenados.length - 1]} de ${mesActual} de ${añoActual}`;

      // Título centrado
      doc.setFontSize(14);
      doc.setFont(undefined, "bold");
      doc.text(`Solicitud de ${tipoPermiso}`, doc.internal.pageSize.getWidth() / 2, 30, { align: "center" });

      // Cuerpo del oficio
      doc.setFontSize(12);
      doc.setFont(undefined, "normal");

      const cuerpoOficio = `
Se solicita tener a bien aprobar mi día de ${tipoPermiso.toLowerCase()} correspondiente al periodo comprendido entre el ${fechaInicio} y el ${fechaFin}.
            
Desde ya muchas gracias.`;

      const lines = doc.splitTextToSize(cuerpoOficio, 170);
      let startY = 40;

      lines.forEach(line => {
        doc.text(line, 20, startY);
        startY += 10;
      });

      // Fecha (lado derecho)
      const fechaHoy = new Date().toLocaleDateString("es-CL");
      startY += 20;
      doc.text(`Santiago, ${fechaHoy}`, doc.internal.pageSize.getWidth() - 20, startY, { align: "right" });

      // Saludo final
      startY += 10;
      doc.text("Atentamente,", 20, startY);

      // Línea de firma
      const firmaY = startY + 10;
      const startX = 20;
      const endX = 80;
      doc.line(startX, firmaY, endX, firmaY);
      doc.text("_____________________", 20, firmaY + 5);

      // Nombre y RUT alineados a la derecha
      const textoFinal = `${nombre}\n${rut}`;
      doc.text(textoFinal, endX + 10, firmaY + 5, { align: "right" });

      // Guardar el PDF
      doc.save(`solicitud_${tipoPermiso.toLowerCase().replace(/\s+/g, '_')}.pdf`);
      closeModal();
    }

    // Funcionalidad de edición de perfil
    const editProfileButton = document.getElementById('edit-profile-button');
    const editProfileForm = document.getElementById('edit-profile-form');
    const profileData = {
      nombreDisplay: document.getElementById('nombre-display'),
      rutDisplay: document.getElementById('rut-display'),
      direccionDisplay: document.getElementById('direccion-display'),
      telefonoDisplay: document.getElementById('telefono-display'),
      correoDisplay: document.getElementById('correo-display'),
      profilePic: document.getElementById('profile-pic')
    };

    const inputs = {
      nombre: document.getElementById('nombre-input'),
      rut: document.getElementById('rut-input'),
      direccion: document.getElementById('direccion-input'),
      telefono: document.getElementById('telefono-input'),
      correo: document.getElementById('correo-input'),
      foto: document.getElementById('foto-input')
    };

    editProfileButton.addEventListener('click', () => {
      editProfileForm.style.display = 'block';
      inputs.nombre.value = profileData.nombreDisplay.textContent;
      inputs.rut.value = profileData.rutDisplay.textContent;
      inputs.direccion.value = profileData.direccionDisplay.textContent;
      inputs.telefono.value = profileData.telefonoDisplay.textContent;
      inputs.correo.value = profileData.correoDisplay.textContent;
    });

    function hideEditForm() {
      editProfileForm.style.display = 'none';
    }

    function saveProfile() {
      const nuevoNombre = inputs.nombre.value.trim();
      const nuevoRut = inputs.rut.value.trim();
      const nuevaDireccion = inputs.direccion.value.trim();
      const nuevoTelefono = inputs.telefono.value.trim();
      const nuevoCorreo = inputs.correo.value.trim();
      const fotoInput = inputs.foto.files[0];

      if (nuevoNombre) profileData.nombreDisplay.textContent = nuevoNombre;
      if (nuevoRut) profileData.rutDisplay.textContent = nuevoRut;
      if (nuevaDireccion) profileData.direccionDisplay.textContent = nuevaDireccion;
      if (nuevoTelefono) profileData.telefonoDisplay.textContent = nuevoTelefono;
      if (nuevoCorreo) profileData.correoDisplay.textContent = nuevoCorreo;

      if (fotoInput) {
        const reader = new FileReader();
        reader.onload = function(e) {
          profileData.profilePic.src = e.target.result;
        };
        reader.readAsDataURL(fotoInput);
      }

      hideEditForm();
    }

    // Mostrar login al cargar
    showPage(loginPage);
  </script>
</body>
</html>
