<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal de Usuario</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins :wght@400;600&display=swap" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #e0e0e0;
      overflow: hidden;
      position: relative;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .cloud-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 200%;
      height: 100%;
      background: linear-gradient(to bottom, #a0c0e0, #c0d0e0);
      animation: moveClouds 60s linear infinite;
      z-index: -2;
    }

    @keyframes moveClouds {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .page-container {
      max-width: 600px;
      width: 90%;
      margin: 50px auto;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      z-index: 1;
      position: relative;
      transition: transform 0.3s ease-in-out;
      display: none;
      box-sizing: border-box;
    }

    .page-container:hover {
      transform: translateY(-5px);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.4);
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      color: #333;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    button {
      background-color: rgba(100, 149, 237, 0.7);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      backdrop-filter: blur(5px);
      display: block;
      width: 100%;
      margin-top: 20px;
    }

    button:hover {
      background-color: rgba(70, 130, 180, 0.8);
      transform: scale(1.02) translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #profile-page h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .profile-info p {
      margin-bottom: 10px;
      color: #555;
      padding: 8px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
    }

    .profile-info strong {
      color: #333;
    }

    #calendar-page .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 10px;
    }

    #calendar-page .calendar-header h2 {
      margin: 0;
      font-size: 1.5em;
      color: #333;
    }

    #calendar-page .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
    }

    #calendar-page .day-name {
      font-weight: bold;
      color: #555;
      padding: 10px 0;
    }

    #calendar-page .day {
      padding: 10px 5px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      position: relative;
      overflow: hidden;
      color: #333;
    }

    #calendar-page .day:hover {
      background-color: rgba(255, 255, 255, 0.6);
      transform: scale(1.05);
    }

    #calendar-page .day.other-month {
      opacity: 0.5;
      pointer-events: none;
    }

    #calendar-page .day.today {
      font-weight: bold;
      border: 2px solid rgba(255, 99, 71, 0.7);
    }

    #calendar-page .day.selected {
      background-color: rgba(255, 165, 0, 0.7);
      color: white;
      font-weight: bold;
    }

    #calendar-page .day.holiday,
    #calendar-page .day.weekend {
      background-color: rgba(255, 69, 0, 0.6);
      color: white;
      font-weight: bold;
      cursor: not-allowed !important;
    }

    #calendar-page .day.disabled {
      background-color: rgba(255, 69, 0, 0.3);
      color: white;
      cursor: not-allowed;
      pointer-events: none;
    }

    #calendar-page .day .event-indicator {
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6em;
      color: rgba(255, 255, 255, 0.8);
    }

    #calendar-page .day.holiday .event-indicator {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-content select,
    .modal-content button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 1em;
    }

    /* Formulario de edición de perfil */
    .edit-profile-form {
      display: none;
      margin-top: 20px;
    }

    .edit-profile-form input[type="text"],
    .edit-profile-form input[type="email"] {
      width: 100%;
      margin-bottom: 10px;
    }

    .edit-profile-form label {
      display: block;
      margin-bottom: 5px;
      color: #333;
    }

    .edit-profile-form input[type="file"] {
      margin-top: 10px;
    }

    .profile-photo {
      text-align: center;
      margin-bottom: 20px;
    }

    .profile-photo img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.5);
    }

    /* Media query para dispositivos móviles */
    @media (max-width: 768px) {
      .page-container {
        padding: 20px;
      }
      #calendar-page .calendar-header h2 {
        font-size: 1.2em;
      }
      #calendar-page .calendar-header button {
        padding: 6px 10px;
        font-size: 0.9em;
      }
      #calendar-page .day {
        padding: 8px 3px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>

<!-- Fondo animado -->
<div class="cloud-background"></div>

<!-- Contenedores -->
<div id="login-page" class="page-container">
  <h2>Iniciar Sesión</h2>
  <div class="form-group">
    <label for="email">Correo Electrónico:</label>
    <input type="email" id="email" placeholder="Ingresa tu correo" />
  </div>
  <div class="form-group">
    <label for="password">Contraseña:</label>
    <input type="password" id="password" placeholder="Ingresa tu contraseña" />
  </div>
  <button id="login-button">Entrar</button>
</div>

<div id="profile-page" class="page-container">
  <div class="profile-photo">
    <img id="profile-pic" src="https://placehold.co/100x100/cccccc/999999?text=Foto+Perfil " alt="Foto de perfil">
  </div>
  <h2>Mi Perfil</h2>
  <div class="profile-info">
    <p><strong>Nombre Completo:</strong> <span id="nombre-display">Ruth Pérez</span></p>
    <p><strong>RUT:</strong> <span id="rut-display">12.345.678-9</span></p>
    <p><strong>Dirección:</strong> <span id="direccion-display">Calle Falsa 123, Santiago</span></p>
    <p><strong>Teléfono:</strong> <span id="telefono-display">+56 9 1234 5678</span></p>
    <p><strong>Correo:</strong> <span id="correo-display">ruth.perez@example.com</span></p>
  </div>
  <button id="edit-profile-button">Editar Perfil</button>
  <button id="manage-permissions-button">Gestionar Permisos y Feriados</button>
  <button onclick="showPage(loginPage)" style="margin-top: 10px;">⬅️ Atrás</button>

  <!-- Formulario de edición de perfil -->
  <div id="edit-profile-form" class="edit-profile-form">
    <h3>Editar Datos</h3>
    <div class="form-group">
      <label for="nombre-input">Nombre:</label>
      <input type="text" id="nombre-input" placeholder="Tu nombre completo">
    </div>
    <div class="form-group">
      <label for="rut-input">RUT:</label>
      <input type="text" id="rut-input" placeholder="Ej: 12.345.678-9">
    </div>
    <div class="form-group">
      <label for="direccion-input">Dirección:</label>
      <input type="text" id="direccion-input" placeholder="Tu dirección">
    </div>
    <div class="form-group">
      <label for="telefono-input">Teléfono:</label>
      <input type="text" id="telefono-input" placeholder="+56 9 1234 5678">
    </div>
    <div class="form-group">
      <label for="correo-input">Correo:</label>
      <input type="email" id="correo-input" placeholder="tu@email.com">
    </div>
    <div class="form-group">
      <label for="foto-input">Subir Foto:</label>
      <input type="file" id="foto-input" accept="image/*">
    </div>
    <button onclick="saveProfile()">Guardar Cambios</button>
    <button onclick="hideEditForm()">Cancelar</button>
  </div>
</div>

<div id="calendar-page" class="page-container">
  <div class="calendar-header">
    <div class="nav-buttons">
      <button id="prevMonth">Anterior</button>
      <button id="nextMonth">Siguiente</button>
    </div>
    <h2 id="currentMonthYear"></h2>
  </div>
  <div class="calendar-grid"></div>
  <button id="confirm-selection-button" style="display: none;">Confirmar Selección</button>
  <button id="back-to-profile-button" class="back-button">Volver al Perfil</button>
</div>

<!-- Modal para solicitar permiso -->
<div class="modal" id="request-modal">
  <div class="modal-content">
    <h3>Seleccionaste <span id="selected-days-count">0</span> día(s)</h3>
    <select id="leave-type">
      <option value="Administrativo">Permiso Administrativo</option>
      <option value="Enfermedad">Licencia Médica</option>
      <option value="Matrimonio">Permiso por Matrimonio</option>
      <option value="Feriado">Feriado</option>
    </select>
    <button onclick="generatePDF()">Descargar PDF</button>
    <button onclick="closeModal()">Cerrar</button>
  </div>
</div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>

<script>
  const loginPage = document.getElementById('login-page');
  const profilePage = document.getElementById('profile-page');
  const calendarPage = document.getElementById('calendar-page');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginButton = document.getElementById('login-button');
  const managePermissionsButton = document.getElementById('manage-permissions-button');
  const backToProfileButton = document.getElementById('back-to-profile-button');
  const prevMonthButton = document.getElementById('prevMonth');
  const nextMonthButton = document.getElementById('nextMonth');
  const calendarGrid = document.querySelector('#calendar-page .calendar-grid');
  const currentMonthYear = document.getElementById('currentMonthYear');
  const confirmSelectionButton = document.getElementById('confirm-selection-button');
  const modal = document.getElementById('request-modal');
  const leaveTypeSelect = document.getElementById('leave-type');
  const selectedDaysCount = document.getElementById('selected-days-count');

  let currentDate = new Date();
  let selectedDays = [];

  // Elementos del perfil
  const editProfileButton = document.getElementById('edit-profile-button');
  const editProfileForm = document.getElementById('edit-profile-form');

  const profileElements = {
    nombre: document.getElementById('nombre-display'),
    rut: document.getElementById('rut-display'),
    direccion: document.getElementById('direccion-display'),
    telefono: document.getElementById('telefono-display'),
    correo: document.getElementById('correo-display'),
    profilePic: document.getElementById('profile-pic')
  };

  const inputFields = {
    nombre: document.getElementById('nombre-input'),
    rut: document.getElementById('rut-input'),
    direccion: document.getElementById('direccion-input'),
    telefono: document.getElementById('telefono-input'),
    correo: document.getElementById('correo-input'),
    foto: document.getElementById('foto-input')
  };

  // Feriados chilenos
  const chileanHolidays = [
    { month: 0, day: 1 },
    { month: 3, day: 18 },
    { month: 3, day: 19 },
    { month: 4, day: 1 },
    { month: 4, day: 21 },
    { month: 5, day: 26 },
    { month: 6, day: 16 },
    { month: 7, day: 15 },
    { month: 8, day: 18 },
    { month: 8, day: 19 },
    { month: 9, day: 31 },
    { month: 10, day: 1 },
    { month: 11, day: 8 },
    { month: 11, day: 25 }
  ];

  function showPage(pageElement) {
    [loginPage, profilePage, calendarPage].forEach(p => p.style.display = 'none');
    pageElement.style.display = 'block';
    if (pageElement === calendarPage) renderCalendar(currentDate);
  }

  loginButton.addEventListener('click', () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    if (email && password) {
      localStorage.setItem('loggedIn', 'true');
      showPage(profilePage);
    } else {
      alert('Por favor, ingresa tu correo y contraseña.');
    }
  });

  managePermissionsButton.addEventListener('click', () => showPage(calendarPage));
  backToProfileButton.addEventListener('click', () => showPage(profilePage));

  prevMonthButton.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });

  nextMonthButton.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });

  function isHoliday(month, day) {
    return chileanHolidays.some(h => h.month === month && h.day === day);
  }

  function isWeekend(date) {
    const dayOfWeek = date.getDay(); // domingo = 0, lunes = 1 ... sábado = 6
    return dayOfWeek === 0 || dayOfWeek === 6;
  }

  function renderCalendar(date) {
    calendarGrid.innerHTML = '';
    const year = date.getFullYear();
    const month = date.getMonth();

    // Mostrar nombres de los días de la semana
    const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
    dayNames.forEach(name => {
      const div = document.createElement('div');
      div.classList.add('day-name');
      div.textContent = name;
      calendarGrid.appendChild(div);
    });

    // Configurar mes y año
    currentMonthYear.textContent = new Intl.DateTimeFormat('es-CL', { month: 'long', year: 'numeric' }).format(date);

    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth = new Date(year, month + 1, 0);
    const numDaysInMonth = lastDayOfMonth.getDate();

    let firstDayOfWeek = firstDayOfMonth.getDay();
    firstDayOfWeek = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1;

    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = firstDayOfWeek; i > 0; i--) {
      const div = document.createElement('div');
      div.classList.add('day', 'other-month');
      div.textContent = prevMonthLastDay - i + 1;
      calendarGrid.appendChild(div);
    }

    for (let i = 1; i <= numDaysInMonth; i++) {
      const dayDiv = document.createElement('div');
      dayDiv.classList.add('day');
      dayDiv.textContent = i;
      const currentDay = new Date(year, month, i);

      // Verificar si es fin de semana
      if (isWeekend(currentDay)) {
        dayDiv.classList.add('weekend', 'disabled');
        const indicator = document.createElement('span');
        indicator.classList.add('event-indicator');
        indicator.textContent = 'Fin de Semana';
        dayDiv.appendChild(indicator);
        calendarGrid.appendChild(dayDiv);
        continue;
      }

      // Verificar si es feriado
      if (isHoliday(month, i)) {
        dayDiv.classList.add('holiday', 'disabled');
        const indicator = document.createElement('span');
        indicator.classList.add('event-indicator');
        indicator.textContent = 'Feriado';
        dayDiv.appendChild(indicator);
        calendarGrid.appendChild(dayDiv);
        continue;
      }

      // Día normal, se puede seleccionar
      dayDiv.addEventListener('click', () => {
        dayDiv.classList.toggle('selected');
        updateSelectedDays();
      });

      calendarGrid.appendChild(dayDiv);
    }

    const totalDaysDisplayed = firstDayOfWeek + numDaysInMonth;
    const remainingDays = 42 - totalDaysDisplayed;
    for (let i = 1; i <= remainingDays; i++) {
      const dayDiv = document.createElement('div');
      dayDiv.classList.add('day', 'other-month');
      dayDiv.textContent = i;
      calendarGrid.appendChild(dayDiv);
    }
  }

  function updateSelectedDays() {
    selectedDays = Array.from(document.querySelectorAll('.day.selected')).map(d => parseInt(d.textContent));
    confirmSelectionButton.style.display = selectedDays.length > 0 ? 'block' : 'none';
    if (selectedDays.length > 0) openModal();
  }

  function openModal() {
    selectedDaysCount.textContent = selectedDays.length;
    modal.style.display = 'flex';
  }

  function closeModal() {
    modal.style.display = 'none';
  }

  async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const nombre = profileElements.nombre.textContent.trim();
    const rut = profileElements.rut.textContent.trim();
    const tipoPermiso = leaveTypeSelect.options[leaveTypeSelect.selectedIndex].text;

    const diasOrdenados = [...selectedDays].sort((a, b) => a - b);
    const mesActual = currentDate.toLocaleString("es-ES", { month: "long" });
    const añoActual = currentDate.getFullYear();

    const fechaInicio = `${diasOrdenados[0]} de ${mesActual} de ${añoActual}`;
    const fechaFin = `${diasOrdenados[diasOrdenados.length - 1]} de ${mesActual} de ${añoActual}`;
    const fechaHoy = new Date().toLocaleDateString("es-CL");

    // Título centrado
    doc.setFontSize(14);
    doc.setFont(undefined, "bold");
    doc.text(`Solicitud de ${tipoPermiso}`, doc.internal.pageSize.getWidth() / 2, 30, { align: "center" });

    // Cuerpo del oficio
    doc.setFontSize(12);
    doc.setFont(undefined, "normal");

    let cuerpoOficio;
    if (selectedDays.length === 1) {
      cuerpoOficio = `
Se solicita tener a bien aprobar mi día de ${tipoPermiso.toLowerCase()} correspondiente al periodo comprendido entre el ${fechaInicio}.
Desde ya muchas gracias.`;
    } else {
      cuerpoOficio = `
Se solicita tener a bien aprobar los ${selectedDays.length} días de ${tipoPermiso.toLowerCase()} comprendidos entre el ${fechaInicio} y el ${fechaFin}.
Desde ya muchas gracias.`;
    }

    const lines = doc.splitTextToSize(cuerpoOficio, 170);
    let startY = 40;

    lines.forEach(line => {
      doc.text(line, 20, startY);
      startY += 10;
    });

    // Fecha derecha
    startY += 20;
    doc.text(`La Serena, ${fechaHoy}`, doc.internal.pageSize.getWidth() - 20, startY, { align: "right" });

    // Saludo final
    startY += 10;
    doc.text("Atentamente,", 20, startY);

    // Línea de firma encima del nombre, alineada a la derecha
    const fontSize = 12;
    const charWidthApprox = 0.2 * fontSize;
    const lineLength = nombre.length * charWidthApprox;
    const textX = doc.internal.pageSize.getWidth() - 20;
    const textY = startY + 10;
    const lineStartX = textX - lineLength;

    doc.line(lineStartX, textY, textX, textY);
    doc.text(nombre, textX, textY + 5, { align: "right" });
    doc.text(rut, textX, textY + 15, { align: "right" });

    // Guardar el PDF
    doc.save(`solicitud_${tipoPermiso.toLowerCase().replace(/\s+/g, '_')}.pdf`);
    closeModal();
  }

  // Botones de navegación del calendario
  prevMonthButton.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });

  nextMonthButton.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });

  // Edición de perfil
  editProfileButton.addEventListener('click', () => {
    editProfileForm.style.display = 'block';

    inputFields.nombre.value = profileElements.nombre.textContent;
    inputFields.rut.value = profileElements.rut.textContent;
    inputFields.direccion.value = profileElements.direccion.textContent;
    inputFields.telefono.value = profileElements.telefono.textContent;
    inputFields.correo.value = profileElements.correo.textContent;
  });

  function hideEditForm() {
    editProfileForm.style.display = 'none';
  }

  function saveProfile() {
    const nuevoNombre = inputFields.nombre.value.trim();
    const nuevoRut = inputFields.rut.value.trim();
    const nuevaDireccion = inputFields.direccion.value.trim();
    const nuevoTelefono = inputFields.telefono.value.trim();
    const nuevoCorreo = inputFields.correo.value.trim();
    const fotoInput = inputFields.foto.files[0];

    if (nuevoNombre) profileElements.nombre.textContent = nuevoNombre;
    if (nuevoRut) profileElements.rut.textContent = nuevoRut;
    if (nuevaDireccion) profileElements.direccion.textContent = nuevaDireccion;
    if (nuevoTelefono) profileElements.telefono.textContent = nuevoTelefono;
    if (nuevoCorreo) profileElements.correo.textContent = nuevoCorreo;

    if (fotoInput) {
      const reader = new FileReader();
      reader.onload = function(e) {
        profileElements.profilePic.src = e.target.result;
        localStorage.setItem('profilePhoto', e.target.result);
      };
      reader.readAsDataURL(fotoInput);
    }

    localStorage.setItem('userName', nuevoNombre || '');
    localStorage.setItem('userRut', nuevoRut || '');
    localStorage.setItem('userDireccion', nuevaDireccion || '');
    localStorage.setItem('userTelefono', nuevoTelefono || '');
    localStorage.setItem('userCorreo', nuevoCorreo || '');

    hideEditForm();
  }

  // Carga inicial desde localStorage
  window.onload = () => {
    const savedName = localStorage.getItem('userName') || "Ruth Pérez";
    const savedRut = localStorage.getItem('userRut') || "12.345.678-9";
    const savedDireccion = localStorage.getItem('userDireccion') || "Calle Falsa 123, La Serena";
    const savedTelefono = localStorage.getItem('userTelefono') || "+56 9 1234 5678";
    const savedCorreo = localStorage.getItem('userCorreo') || "ruth.perez@example.com";
    const savedPhoto = localStorage.getItem('profilePhoto') || "https://placehold.co/100x100/cccccc/999999?text=Foto+Perfil ";

    profileElements.nombre.textContent = savedName;
    profileElements.rut.textContent = savedRut;
    profileElements.direccion.textContent = savedDireccion;
    profileElements.telefono.textContent = savedTelefono;
    profileElements.correo.textContent = savedCorreo;
    profileElements.profilePic.src = savedPhoto;

    showPage(loginPage);
  };

  // Mostrar botón de confirmación y mostrar días seleccionados
  confirmSelectionButton.addEventListener('click', () => {
    if (selectedDays.length > 0) openModal();
  });
</script>
</body>
</html>
